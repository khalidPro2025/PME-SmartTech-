version: "3.8"

networks:
  services:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24

  clients:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/24

volumes:
  bind9_data:
  ftp_data:
  ssh_data:
  asterisk_data:
  asterisk_spool:
  asterisk_logs:
  mail_data:
  novnc_data:
  shared_data:
  samba_data:
  fastapi_data:
  traefik_data:

services:

  traefik:
    image: traefik:v2.10
    container_name: smarttech_traefik
    hostname: traefik.smarttech.local
    environment:
      - TZ=Africa/Dakar
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/acme.json:/letsencrypt/acme.json
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./traefik/dynamic.yml:/etc/traefik/dynamic.yml:ro
      - traefik_data:/letsencrypt
    networks:
      services:
        ipv4_address: 172.20.0.5
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--spider", "--timeout=2", "-q", "http://127.0.0.1:8080/ping" ]
      interval: 30s
      timeout: 3s
      retries: 3

  bind9:
    image: internetsystemsconsortium/bind9:9.18
    container_name: smarttech_bind9
    hostname: dns.smarttech.local
    environment:
      - TZ=Africa/Dakar
    volumes:
      - ./bind9/named.conf.local:/etc/bind/named.conf.local:ro
      - ./bind9/zones:/etc/bind/zones:ro
      - bind9_data:/var/cache/bind
    networks:
      services:
        ipv4_address: 172.20.0.10
      clients:
        ipv4_address: 172.21.0.10
    ports:
      - "1053:53/udp"
      - "1053:53/tcp"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "dig", "@127.0.0.1", "portal.smarttech.local", "A", "+short"]
      interval: 30s
      timeout: 5s
      retries: 3

  ftp:
    build: ./ftp
    container_name: smarttech_ftp
    hostname: ftp.smarttech.local
    environment:
      - TZ=Africa/Dakar
      - FTP_USER=ftpuser
      - FTP_PASS=ftpPass123!
    volumes:
      - ftp_data:/home/ftpuser/ftp
      - shared_data:/shared
      - ./ftp/vsftpd.conf:/etc/vsftpd.conf:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ftp.rule=Host(`ftp.smarttech.local`)"
      - "traefik.http.routers.ftp.entrypoints=websecure"
      - "traefik.http.routers.ftp.tls.certresolver=le"
    networks:
      services:
        ipv4_address: 172.20.0.11
    ports:
      - "21:21"
      - "30000-30010:30000-30010"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "nc -zv 127.0.0.1 21 >/dev/null 2>&1"]
      interval: 20s
      timeout: 5s
      retries: 3

  ssh:
    build: ./ssh
    container_name: smarttech_ssh
    hostname: ssh.smarttech.local
    environment:
      - TZ=Africa/Dakar
    volumes:
      - ssh_data:/home/sshuser
      - shared_data:/shared
      - ./ssh/sshd_config:/etc/ssh/sshd_config:ro
    networks:
      services:
        ipv4_address: 172.20.0.12
    ports:
      - "2222:22"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "ss -tnlp | grep :22 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3

  asterisk:
    image: andrius/asterisk:latest
    container_name: smarttech_asterisk
    hostname: sip.smarttech.local
    environment:
      - TZ=Africa/Dakar
    volumes:
      - asterisk_data:/etc/asterisk
      - asterisk_spool:/var/spool/asterisk
      - asterisk_logs:/var/log/asterisk
      - ./asterisk/sip.conf:/etc/asterisk/sip.conf:ro
      - ./asterisk/extensions.conf:/etc/asterisk/extensions.conf:ro
      - ./asterisk/users.conf:/etc/asterisk/users.conf:ro
    networks:
      services:
        ipv4_address: 172.20.0.13
      clients:
        ipv4_address: 172.21.0.13
    ports:
      - "5060:5060/udp"
      - "5060:5060/tcp"
      - "10000-10100:10000-10100/udp"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "asterisk -rx 'core show channels' >/dev/null 2>&1"]
      interval: 30s
      timeout: 10s
      retries: 3

  mail:
    image: mailserver/docker-mailserver:latest
    container_name: smarttech_mail
    hostname: mail.smarttech.local
    environment:
      - TZ=Africa/Dakar
      - ENABLE_SPAMASSASSIN=1
      - ENABLE_CLAMAV=1
      - ENABLE_FAIL2BAN=1
      - ONE_DIR=1
      - PERMIT_DOCKER=host
      - SSL_TYPE=self-signed
    volumes:
      - mail_data:/var/mail
      - shared_data:/shared
      - ./mail/config/:/tmp/docker-mailserver/:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mail.rule=Host(`mail.smarttech.local`)"
      - "traefik.http.routers.mail.entrypoints=websecure"
      - "traefik.http.routers.mail.tls.certresolver=le"
    networks:
      services:
        ipv4_address: 172.20.0.14
    ports:
      - "25:25"
      - "587:587"
      - "993:993"
      - "143:143"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "nc -z 127.0.0.1 25 || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3

  novnc:
    build: ./novnc
    container_name: smarttech_novnc
    hostname: novnc.smarttech.local
    environment:
      - TZ=Africa/Dakar
      - VNC_PASSWORD=vncPass123!
      - DISPLAY=:0
    volumes:
      - novnc_data:/home/ubuntu
      - shared_data:/shared
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.novnc.rule=Host(`vnc.smarttech.local`)"
      - "traefik.http.routers.novnc.entrypoints=websecure"
      - "traefik.http.routers.novnc.tls.certresolver=le"
    networks:
      services:
        ipv4_address: 172.20.0.15
    ports:
      - "6080:80"
      - "5900:5900"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80/ || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 3

  samba:
    image: dperson/samba
    container_name: smarttech_samba
    hostname: smb.smarttech.local
    environment:
      - TZ=Africa/Dakar
    command: >
      -u "smbuser;smbPass123!"
      -s "shared;/shared;yes;no;yes;all"
    volumes:
      - shared_data:/shared
    networks:
      services:
        ipv4_address: 172.20.0.16
    ports:
      - "445:445"
      - "139:139"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "bash", "-lc", "smbstatus >/dev/null 2>&1 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3

  fastapi:
    build: ./fastapi
    container_name: smarttech_fastapi
    hostname: api.smarttech.local
    environment:
      - TZ=Africa/Dakar
    volumes:
      - ./fastapi:/app
      - fastapi_data:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.smarttech.local`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=le"
      - "traefik.http.services.api.loadbalancer.server.port=8000"
    networks:
      services:
        ipv4_address: 172.20.0.17
    ports:
      - "8000:8000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8000/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3

  portal:
    build: ./portal
    container_name: smarttech_portal
    hostname: portal.smarttech.local
    environment:
      - TZ=Africa/Dakar
    volumes:
      - ./portal:/usr/share/nginx/html:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.portal.rule=Host(`portal.smarttech.local`)"
      - "traefik.http.routers.portal.entrypoints=websecure"
      - "traefik.http.routers.portal.tls.certresolver=le"
      - "traefik.http.services.portal.loadbalancer.server.port=80"
    networks:
      services:
        ipv4_address: 172.20.0.18
    ports:
      - "8081:80"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:80/ || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
